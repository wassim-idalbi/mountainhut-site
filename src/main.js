import e from"./ContentManager.js";import t from"./gameState.js";import n from"./challenges/letterPIN.js";import a from"./challenges/decipherEmojiMap.js";import s from"./challenges/extractAllWords.js";import o from"./challenges/guessTheStringFromEmojis.js";import r from"./challenges/safeMath.js";import c from"./utils/toast.js";const i=new class{constructor(){this.currentChallenge=null,this.codesData=null}async init(){try{await e.init();const t=await fetch("assets/data/codes.json");this.codesData=await t.json(),this.bindGlobalHandlers(),this.showScreen("welcome-screen"),console.log("Game initialized successfully!")}catch(e){console.error("Failed to initialize game:",e)}}bindGlobalHandlers(){$("#languageSwitchBtn").on("click",()=>{e.switchLanguage()}),$(document).on("click",".welcome-screen .btn-primary",()=>{this.startGame()}),$(document).on("click",'.bottom-nav .btn-secondary:contains("إعادة"), .bottom-nav .btn-secondary:contains("Restart")',()=>{confirm("ar"===t.currentLanguage?"هل تريد إعادة اللعبة؟":"Restart the game?")&&this.restartGame()}),$(document).on("click",".challenge-screen .btn-back",()=>{t.reset(),this.updateProgressBar(),this.showScreen("welcome-screen")}),$(document).on("click",".exchange-screen .btn-back",()=>{const e=t.getCurrentChallengeId();this.showChallengeScreen(e)}),$(document).on("click",".exchange-screen .btn-warning",()=>{this.validateCode()}),$(document).on("click",".exchange-screen .btn-small",()=>{$(".exchange-input").val(""),$(".exchange-input").first().focus()}),$(document).on("input",".exchange-input",function(){const e=$(this);1===e.val().length&&e.next(".exchange-input").focus()}),$(document).on("paste",".exchange-input",e=>{e.preventDefault();const t=(e.originalEvent.clipboardData||window.clipboardData).getData("text").toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,4),n=$(".exchange-input");for(let e=0;e<t.length&&e<4;e++)n.eq(e).val(t[e])}),$(document).on("challengeComplete",(e,t)=>{this.onChallengeComplete(t)}),$(document).on("click",".treasure-instructions-screen .btn-primary",()=>{this.showFinalPrize()}),$(document).on("click",".victory-screen .btn-primary",()=>{this.restartGame()})}showScreen(e){$(".screen").closest(".game-card").hide(),$(`.${e}`).closest(".game-card").fadeIn(300),this.updateLanguageButtonVisibility(e),window.scrollTo({top:0,behavior:"smooth"})}updateLanguageButtonVisibility(e){const t=$("#languageSwitchBtn");"welcome-screen"===e?t.show():t.hide()}startGame(){t.startGame(),this.updateProgressBar();const e=t.getCurrentChallengeId();this.showChallengeScreen(e)}showChallengeScreen(t){this.currentChallenge&&(this.currentChallenge.destroy(),this.currentChallenge=null);const c=e.getChallengeData(t);if(!c)return void console.error(`Challenge data not found for: ${t}`);$(".screen").closest(".game-card").hide(),$(`[data-challenge-id="${t}"]`).closest(".game-card").fadeIn(300),this.updateLanguageButtonVisibility("challenge-screen"),window.scrollTo({top:0,behavior:"smooth"});const{type:i,content:l,puzzleData:h}=c,g=l.hints||[];switch(i){case"letterPIN":this.currentChallenge=new n(t,h,g);break;case"decipherEmojiMap":this.currentChallenge=new a(t,h,g);break;case"extractAllWords":this.currentChallenge=new s(t,h,g);break;case"guessTheStringFromEmojis":this.currentChallenge=new o(t,h,g);break;case"safeMath":this.currentChallenge=new r(t,h,g);break;default:return void console.error(`Unknown challenge type: ${i}`)}this.currentChallenge.init(),this.updateProgressBar()}onChallengeComplete(e){t.completeChallenge(e),"tent_challenge"===e?(t.currentChallengeIndex++,this.showTreasureInstructions()):this.showCodeEntryScreen()}showCodeEntryScreen(){this.showScreen("exchange-screen");const n=["kitchen","green_seating","playground","barbecue","bedroom","tent"][t.currentChallengeIndex+1],a=e.getLocationName(n),s={kitchen:"https://mountainhut.co/assetsimages/kitchen.jpg",green_seating:"https://mountainhut.co/assetsimages/greenery.jpg",playground:"https://mountainhut.co/assetsimages/playground.jpg",barbecue:"https://mountainhut.co/assetsimages/barbecue.jpg",bedroom:"https://mountainhut.co/assetsimages/bedroom.jpg",tent:"https://mountainhut.co/assetsimages/hut.jpg"}[n];$(".exchange-screen .next-location-name").text(a),$(".exchange-screen .next-location-thumbnail").attr("src",s),$(".exchange-input").val(""),$(".exchange-input").first().focus(),this.updateProgressBar()}validateCode(){const n=$(".exchange-input").map(function(){return $(this).val()}).get().join("").toUpperCase();if(4!==n.length)return void c.warning(e.getTranslation("systemMessages.codeFormat"));const a=t.currentLocationId,s=this.codesData.codes.find(e=>e.locationId===a);if(s)if(n===s.correctCode.toUpperCase()){const e="ar"===t.currentLanguage?"رمز صحيح! 🎉":"Correct code! 🎉";c.success(e),t.addEnteredCode(n),setTimeout(()=>{if(t.advanceToNextChallenge()){const e=t.getCurrentChallengeId();this.showChallengeScreen(e)}else this.showTreasureInstructions()},800)}else c.error(e.getTranslation("systemMessages.codeIncorrect")),$(".exchange-input").val(""),$(".exchange-input").first().focus();else console.error(`No code found for location: ${a}`)}showTreasureInstructions(){$(".game-card").hide(),$(".treasure-instructions-screen").closest(".game-card").fadeIn(300),this.updateLanguageButtonVisibility("final-screen"),this.updateProgressBar(),window.scrollTo({top:0,behavior:"smooth"})}showFinalPrize(){t.isGameComplete=!0,$(".game-card").hide(),$(".victory-screen").closest(".game-card").fadeIn(300),this.updateLanguageButtonVisibility("final-screen"),this.updateProgressBar(),window.scrollTo({top:0,behavior:"smooth"})}updateProgressBar(){const e=t.currentChallengeIndex,n=$(".progress-step"),a=$(".progress-line");n.each((t,n)=>{const a=$(n);t<e?a.addClass("completed"):t===e?a.addClass("active").removeClass("completed"):a.removeClass("active completed")}),a.each((t,n)=>{const a=$(n);t<e?a.addClass("completed"):t===e?a.addClass("active").removeClass("completed"):a.removeClass("active completed")})}restartGame(){this.currentChallenge&&(this.currentChallenge.destroy(),this.currentChallenge=null),t.reset(),this.updateProgressBar(),this.showScreen("welcome-screen")}};$(document).ready(async()=>{try{await i.init(),console.log("Mountain Hut Adventure ready! 🏔️"),window.gameController=i,window.gameState=t,window.contentManager=e}catch(e){console.error("Failed to initialize game:",e)}});